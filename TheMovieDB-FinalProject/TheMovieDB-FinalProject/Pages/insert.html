<!DOCTYPE html>
<html>
<head>

    <meta charset="utf-8" />
    <title>Insert series</title>

    <!-- CSS -->
    <style type="text/css">

        #ph > img {
            margin: 5px;
            padding: 5px;
        }

        #ph > .season,
        #ph > .episode {
            float: left;
        }

        #ph > .season {
            height: 300px;
        }

        .season:hover {
            background-color: darkgrey !important;
            cursor: pointer;
        }

        .season:active {
            background-color: grey !important;
        }

        .red-star {
            color: red;
        }

    </style>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" 
          rel="stylesheet" 
          integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" 
          crossorigin="anonymous">

    <!-- JQuerry -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
            crossorigin="anonymous">
    </script>

    <!-- Sweet Alert -->
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <!-- AJAX -->
    <script src="../Scripts/ajaxCalls.js"></script>

    <!-- Functions -->
    <script>

        // ---------------------------------------- Constroller functions--------------------------
        $(document).ready(function () {
            $("#getTV").click(getTV);
            $("#getEps").click(function () {
                window.location.href = "../Pages/view.html";
            });

            $('#ph').on('click', '.season', function () {
                getSeason($(this).attr('data-seasonNum'));
            });

            $('#ph').on('click', '.episode-btn', function () {
                episodeToAdd = parseInt($(this).attr('data-episodeNum'));
                postSeries();
            });

            $('#logInModal').on('click', '#accessUserBtn', function () {
                getUser();
            });

            $('#signUpModal').submit(signUp);

            $('.navbar').on('click', '#logOutBtn', function () {
                logOut();
            });

            $("#passwordTB").on("blur", validatePassword);
            loadSavedLogIn();
            setMaxDate();


            key = "d8484ecfbfb906740724a447b5d63b12";
            url = "https://api.themoviedb.org/";
            imagePath = "https://image.tmdb.org/t/p/w500";
        });

        // ---------------------------------------- API calls -------------------------------------
        {

            // Users ------------------------------------------------------------------------------

            {

                //--------------------------------------- GET ---------------------------------------

                function getUser() {
                    let api = "../api/Users?email=" + $('#emailLogInTB').val() + "&password=" + $('#passwordLogInTB').val();

                    ajaxCall("GET", api, "", getUserSuccessCB, getUserErrorCB);
                }

                function getUserSuccessCB(user) {
                    logIn(user);
                }

                function getUserErrorCB(err) {
                    console.log(err.status + " " + err.responseJSON.Message);
                    if (err.status == '404')
                        swal("Error!", "404: " + err.responseJSON.Message, "error");
                    else
                        swal("Error!", err.responseJSON.Message, "error");
                }

                //--------------------------------------- POST --------------------------------------

                function postUser() {

                    let user = {
                        First_name: $('#firstNameTB').val(),
                        Last_name: $('#lastNameTB').val(),
                        Email: $('#emailAddressTB').val(),
                        Password: $('#passwordTB').val(),
                        Phone_num: $('#phoneNumTB').val(),
                        Address: $('#addressTB').val(),
                        Fav_genre: $('#favGenreTB').val(),
                        Gender: $('#genderDDL').val(),
                        Birth_date: $('#birthYearTB').val()
                    }

                    let api = "../api/Users";

                    ajaxCall("POST", api, JSON.stringify(user), postUserSuccessCB, postUserErrorCB);
                }

                function postUserSuccessCB(msg) {
                    $('#signUpModal').modal('hide');
                    swal("Success!", msg, "success");
                }

                function postUserErrorCB(err) {
                    console.log(err.status + " " + err.responseJSON.Message);
                    swal("Error!", err.responseJSON.Message, "error");
                }
            }

            // Series -----------------------------------------------------------------------------

            {

                //--------------------------------------- GET ---------------------------------------

                function getTV() {
                    let name = $("#tvShowName").val();
                    let method = "3/search/tv?";
                    let api_key = "api_key=" + key;
                    let moreParams = "&language=en-US&page=1&include_adult=false&";
                    let query = "query=" + encodeURIComponent(name);
                    let apiCall = url + method + api_key + moreParams + query;

                    ajaxCall("GET", apiCall, "", getTVSuccessCB, getTVErrorCB);
                }

                function getTVSuccessCB(tv) {
                    series = tv.results[0];
                    tvId = series.id;
                    renderTV(series);
                }

                function getTVErrorCB(err) {
                    console.log(err.status + " " + err.responseJSON.Message);
                }

                //--------------------------------------- POST --------------------------------------

                function postSeries() {

                    tv_series = {
                        tv_id: series.id,
                        first_air_date: series.first_air_date,
                        name: series.name,
                        origin_country: series.origin_country[0],
                        original_language: series.original_language,
                        overview: series.overview,
                        popularity: series.popularity,
                        poster_path: series.poster_path
                    }

                    let api = "../api/Series";

                    ajaxCall("POST", api, JSON.stringify(tv_series), postSeriesSuccessCB, postSeriesErrorCB);
                }

                function postSeriesSuccessCB(msg) {
                    console.log(msg);
                    postEpisode(episodeToAdd);
                }

                function postSeriesErrorCB(err) {
                    console.log(err.status + " " + err.responseJSON.Message);
                    postEpisode(episodeToAdd);
                }
            }

            // Seasons ----------------------------------------------------------------------------

            {

                //--------------------------------------- GET -------------------------------------

                function getSeasons() {

                    let method = "3/tv/";
                    let api_key = "api_key=" + key;
                    let apiCall = url + method + tvId + "?" + api_key;

                    ajaxCall("GET", apiCall, "", getSeasonsSuccessCB, getSeasonsErrorCB);
                }

                function getSeasonsSuccessCB(seasons) {
                    renderSeasonsList(seasons);
                }

                function getSeasonsErrorCB(err) {
                    console.log(err.status + " " + err.responseJSON.Message);
                }
            }

            // Season episodes --------------------------------------------------------------------

            {

                //--------------------------------------- GET -------------------------------------

                function getSeason(seasonNum) {
                    let apiCall = url + "3/tv/" + tvId + "/season/" + seasonNum + "?" + "api_key=" + key;
                    seasonNumber = seasonNum;
                    ajaxCall("GET", apiCall, "", getSeasonSuccessCB, getSeasonErrorCB)
                }

                function getSeasonSuccessCB(episodes) {
                    renderEpisodes(episodes);
                }

                function getSeasonErrorCB(err) {
                    if (seasonNumber == 0)
                        getSeason(1);
                    else
                        console.log(err.status + " " + err.responseJSON.Message);
                }
            }

            // Episode ----------------------------------------------------------------------------

            {

                //--------------------------------------- POST ------------------------------------

                function postEpisode(epNum) {

                    episode = {
                        Tv_id: tvId,
                        Season_number: episodes[epNum].season_number,
                        Episode_number: episodes[epNum].episode_number,
                        Name: episodes[epNum].name,
                        Still_path: episodes[epNum].still_path,
                        Overview: episodes[epNum].overview,
                        Air_date: episodes[epNum].air_date
                    }

                    let api = "../api/Episodes";

                    ajaxCall("POST", api, JSON.stringify(episode), postEpisodeSuccessCB, postEpisodeErrorCB);
                }

                function postEpisodeSuccessCB(msg) {
                    console.log(msg);
                    postPreference();
                }

                function postEpisodeErrorCB(err) {
                    console.log(err.status + " " + err.responseJSON.Message);
                    postPreference();
                }
            }

            // Preference -------------------------------------------------------------------------

            {

                //--------------------------------------- POST ------------------------------------

                function postPreference() {

                    let preference = {
                        UserPreference: logged_user,
                        EpisodePreference: episode
                    }

                    let api = "../api/Preferences";

                    ajaxCall("POST", api, JSON.stringify(preference), postPreferenceSuccessCB, postPreferenceErrorCB);
                }


                function postPreferenceSuccessCB(msg) {
                    console.log(msg);
                }

                function postPreferenceErrorCB(err) {
                    console.log(err.status + " " + err.responseJSON.Message);
                }

            }

        }

        // ---------------------------------------- Functions -------------------------------------

        {

            function setMaxDate() {
                var today = new Date();
                var dd = today.getDate();
                var mm = today.getMonth() + 1; //January is 0!
                var yyyy = today.getFullYear();
                if (dd < 10) {
                    dd = '0' + dd
                }
                if (mm < 10) {
                    mm = '0' + mm
                }

                today = yyyy + '-' + mm + '-' + dd;
                document.getElementById("birthYearTB").setAttribute("max", today);
            }

            function renderSeasonsList(tv) {
                $("#ph").html("");
                seasons = tv.seasons;
                for (let i = 0; i < seasons.length; i++) {
                    $("#ph").append('<img class="season" src="' + imagePath + seasons[i].poster_path + '" data-seasonNum="' + i + '"/>');
                }
            }

            function renderEpisodes(season) {
                $("#ph").html("");
                episodes = season.episodes;
                for (let i = 0; i < episodes.length; i++) {

                    $("#ph").append(
                        '<div class="card episode me-2" style="width: 18rem;">' +
                            '<img class="card-img-top" src="' + imagePath + episodes[i].still_path + '"/>' +
                            '<div class="card-body">' +
                                '<h5 class="card-title">' + episodes[i].name + '</h5>' +
                                '<p class="card-text">' + episodes[i].overview + '</p>' +
                                '<p> air date: ' + episodes[i].air_date + '</p>' +
                                '<button type="button" class="episode-btn" data-episodeNum="' + i + '">Add this episode</button>'+
                            '</div>'+
                        '</div>'
                    );

                }
            }

            function renderTV(tv) {
                $("#series_page").html("");
                $("#series_page").append(
                "<img src='" + imagePath + tv.poster_path + "'/>" +
                "<h2>" + tv.name + "</h2>" +
                "<p> Vote average: " + tv.vote_average + "<p>" +
                "<p> Origin country: " + tv.origin_country + "<p>" +
                "<p> Original language: " + tv.original_language + "<p>" +
                "<p> Original name: " + tv.original_name + "<p>" +
                "<p>" + tv.overview + "</p>");
                getSeasons(tv.id);
            }

            // User commands

            function validatePassword() {

                let upper = /[A-Z]/;
                let number = /\d/;

                if (this.value.length < 6) {
                    this.validity.valid = false;
                    this.setCustomValidity("Please make sure password is atleast 6 characters.");
                    return;
                }
                if (!number.test(this.value)) {
                    this.validity.valid = false;
                    this.setCustomValidity("Please make sure Password Includes a Digit");
                    return;
                }
                if (!upper.test(this.value)) {
                    this.validity.valid = false;
                    this.setCustomValidity("Please make sure password includes an uppercase letter.");
                    return;
                }
                else {
                    this.validity.valid = true;
                    this.setCustomValidity('');
                }
            }

            function signUp() {
                postUser();
                return false;
            }

            function loadSavedLogIn() {
                logged_user = JSON.parse(localStorage.getItem('user'));
                if (logged_user != null)
                    logIn(logged_user);
                else
                    $("#logOutBtn").hide();
            }

            function logIn(user) {
                delete user.Password; // Remove password before saving to LS.
                localStorage.setItem('user', JSON.stringify(user));
                $("#WlcmMsg").html("Hello, " + user.First_name + " " + user.Last_name + ".");
                $("#logOutBtn").show();
                $("#signUpBtn").hide();
                $("#logInBtn").hide();
                $('#getTV').prop("disabled", false);
                $('#getEps').prop("disabled", false);
                $('#tvShowName').prop("disabled", false);
                $('#logInModal').modal('hide');
            }

            function logOut() {
                $("#logOutBtn").hide();
                $("#WlcmMsg").html("The Movie DB Project");
                $("#signUpBtn").show();
                $("#logInBtn").show();
                $('#getTV').prop("disabled", true);
                $('#getEps').prop("disabled", true);
                $('#tvShowName').val('');
                $('#tvShowName').prop("disabled", true);
                localStorage.clear();
                $('#ph').empty();
            }
        }

    </script>

</head>

<body>
    <!-- Sign up Modal -->
    <div class="modal fade" id="signUpModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">Create a new account:</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="newUser">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="firstNameTB"><span class="red-star">★ </span>First Name:</label>
                            <input type="text" class="form-control" id="firstNameTB" placeholder="Your first name." required>
                        </div>
                        <div class="form-group">
                            <label for="lastNameTB"><span class="red-star">★ </span>Last Name:</label>
                            <input type="text" class="form-control" id="lastNameTB" placeholder="Your last name." required>
                        </div>
                        <div class="form-group">
                            <label for="emailAddressTB"><span class="red-star">★ </span>Email Address:</label>
                            <input type="text" class="form-control" id="emailAddressTB" placeholder="Your email address." required>
                        </div>
                        <div class="form-group">
                            <label for="passwordTB"><span class="red-star">★ </span>Password:</label>
                            <input type="password" class="form-control" id="passwordTB" placeholder="Atleast 6 characters, 1 uppercase, 1 digit." required>
                        </div>
                        <div class="form-group">
                            <label for="phoneNumTB"><span class="red-star">★ </span>Phone Number:</label>
                            <input type="text" class="form-control" id="phoneNumTB" placeholder="0dd-ddddddd"
                                   pattern="[0][0-9]{2}-[0-9]{7}"
                                   oninvalid="this.setCustomValidity('Format should be 0dd-ddddddd')"
                                   oninput="this.setCustomValidity('')"
                                   required>
                        </div>
                        <div class="form-group my-2">
                            <label for="genderDDL"><span class="red-star">★ </span>Gender:</label>
                            <select id="genderDDL" required>
                                <!--required will not accept "" value-->
                                <option value="">Gender</option>
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                                <option value="O">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="birthYearTB"><span class="red-star">★ </span>Birth Year:</label>
                            <input type="date" class="form-control" id="birthYearTB" min='1899-01-01' required>
                        </div>
                        <div class="form-group">
                            <label for="favGenreTB">Favourite Genre:</label>
                            <input type="text" class="form-control" id="favGenreTB" placeholder="Favourite genre.">
                        </div>
                        <div class="form-group">
                            <label for="addressTB"><span class="red-star">★ </span>Address:</label>
                            <input type="text" class="form-control" id="addressTB" placeholder="your address." required>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <input type="submit" class="btn btn-primary my-2 text-center" value="Create Account" />
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Log in Modal -->
    <div class="modal fade" id="logInModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">Log in to an account:</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="firstNameTB">Email:</label>
                        <input type="text" class="form-control" id="emailLogInTB" placeholder="Your email address." required>
                    </div>
                    <div class="form-group">
                        <label for="lastNameTB">Password:</label>
                        <input type="password" class="form-control" id="passwordLogInTB" placeholder="Your password." required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="accessUserBtn">Log In</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Page Top -->
    <nav class="navbar navbar-light bg-light">
        <div class="container justify-content-start" id="#nav">
            <h5 class="me-3" id="WlcmMsg">The Movie DB Project</h5>
            <button type="button" class="btn btn-primary me-3" id="signUpBtn" data-bs-toggle="modal" data-bs-target="#signUpModal">Sign up</button>
            <button type="button" class="btn btn-info me-3" id="logInBtn" data-bs-toggle="modal" data-bs-target="#logInModal">Log in</button>
            <button type="button" class="btn btn-warning" id="logOutBtn">Log Out</button>
        </div>
    </nav>
    <div class="container mt-3">
        <input type="text" id="tvShowName" disabled />
        <button id="getTV" disabled>Get TV Show</button>
        <button id="getEps" disabled>List Episodes</button>
        <div id="series_page">
        </div>
        <div id="ph">

        </div>
    </div>


    <!-- Bootstrap dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" 
            crossorigin="anonymous"></script>

</body>

</html>